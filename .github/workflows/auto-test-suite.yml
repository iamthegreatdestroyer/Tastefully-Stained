name: ðŸ§ª Automated Test Suite
on:
    push:
        branches: [main, develop]
        paths:
            - "backend/**"
            - "frontend/**"
            - "requirements.txt"
            - "package.json"
    pull_request:
        branches: [main]
    schedule:
        - cron: "0 2 * * *" # Nightly tests

jobs:
    test-backend:
        runs-on: ubuntu-latest
        services:
            postgres:
                image: postgres:15-alpine
                env:
                    POSTGRES_PASSWORD: postgres
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
            redis:
                image: redis:7-alpine
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install pytest-cov pytest-xdist pytest-timeout

            - name: Run unit tests (parallel)
              run: |
                  pytest backend/tests/unit \
                    -v \
                    --tb=short \
                    -n auto \
                    --timeout=30 \
                    --cov=backend \
                    --cov-report=xml \
                    --cov-report=html || true

            - name: Run integration tests
              run: |
                  pytest backend/tests/integration \
                    -v \
                    --tb=short \
                    --timeout=60 \
                    -m "not slow" || true

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v3
              with:
                  files: ./coverage.xml
                  flags: backend
                  fail_ci_if_error: false

            - name: Upload test artifacts
              if: always()
              uses: actions/upload-artifact@v3
              with:
                  name: test-results
                  path: |
                      coverage.xml
                      htmlcov/

    test-frontend:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "18"
                  cache: "npm"

            - name: Install dependencies
              run: cd frontend && npm ci || true

            - name: Run tests
              run: cd frontend && npm run test:coverage 2>/dev/null || true

            - name: Upload coverage
              uses: codecov/codecov-action@v3
              with:
                  files: ./frontend/coverage/coverage-final.json
                  flags: frontend
                  fail_ci_if_error: false

    security-scan:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  format: "sarif"
                  output: "trivy-results.sarif"

            - name: Upload Trivy results to GitHub Security
              uses: github/codeql-action/upload-sarif@v2
              with:
                  sarif_file: "trivy-results.sarif"

    code-quality:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Install dependencies
              run: |
                  pip install -r requirements.txt
                  pip install pylint black isort flake8 mypy

            - name: Run Black formatter check
              run: black --check backend/ || true

            - name: Run isort import sorter
              run: isort --check-only backend/ || true

            - name: Run Flake8 linter
              run: flake8 backend/ --max-line-length=100 --count || true

            - name: Run MyPy type checker
              run: mypy backend/ --ignore-missing-imports || true

            - name: Run PyLint
              run: pylint backend/ --exit-zero || true
