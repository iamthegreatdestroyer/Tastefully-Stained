# Tastefully Stained - Deploy Workflow
# Deploys to production after successful build

name: Deploy

on:
  workflow_run:
    workflows: [Build]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts || true

      - name: Deploy with Docker Compose
        run: |
          echo "Deployment would happen here"
          echo "Using docker-compose pull && docker-compose up -d"
          # ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "cd /opt/tastefully-stained && docker-compose pull && docker-compose up -d"

      - name: Health check
        run: |
          echo "Health check would happen here"
          # curl -f http://${{ secrets.DEPLOY_HOST }}/api/v1/health || exit 1

      - name: Notify on success
        if: success()
        run: |
          echo "✅ Deployment successful!"
          # Could send Slack/Discord notification here

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          # Could trigger rollback and send alert here
